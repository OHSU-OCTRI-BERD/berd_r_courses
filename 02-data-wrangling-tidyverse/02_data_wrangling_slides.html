<!DOCTYPE html>
<html>
  <head>
    <title>Data Wrangling in R with the Tidyverse</title>
    <meta charset="utf-8">
    <meta name="author" content="Jessica Minnier, PhD &amp; Meike Niederhausen, PhD OCTRI Biostatistics, Epidemiology, Research &amp; Design (BERD) Workshop" />
    <link href="libs/font-awesome/css/fontawesome-all.min.css" rel="stylesheet" />
    <script src="https://use.fontawesome.com/5235085b15.js"></script>
    <link rel="stylesheet" href="css/xaringan-themer.css" type="text/css" />
    <link rel="stylesheet" href="css/my-theme.css" type="text/css" />
  </head>
  <body>
    <textarea id="source">
class: left, middle, inverse, title-slide

# Data Wrangling in R with the Tidyverse
### Jessica Minnier, PhD &amp; Meike Niederhausen, PhD<br><span style="font-size: 80%;"><a href="https://www.ohsu.edu/xd/research/centers-institutes/octri/education-training/octri-research-forum.cfm">OCTRI Biostatistics, Epidemiology, Research &amp; Design (BERD) Workshop</a> </span>
### <span style="font-size: 80%;">2019/04/18 (Part 1) &amp; 2019/04/25 (Part 2) <br><br><br> <i class="fas  fa-link "></i> slides: <a href="http://bit.ly/berd_tidy">bit.ly/berd_tidy</a> <br> <i class="fas  fa-file-pdf "></i> pdf: <a href="http://bit.ly/berd_tidy_pdf">bit.ly/berd_tidy_pdf</a></span>

---


layout: true
  
&lt;div class="my-footer"&gt;&lt;span&gt;bit.ly/berd_tidy&lt;/span&gt;&lt;/div&gt; 

---









# Pre-course homework

Open these slides [bit.ly/berd_tidy]()

Open the homework: [find it here](https://jminnier-berd-r-courses.netlify.com/02-data-wrangling-tidyverse/02_pre_course_homework.html)

---

# Learning Objectives

- What is data wrangling?
- A few good practices in R/Rstudio
- What is tidy data?
- What is tidyverse?
- Reshape and manipulate data frames
- Some data cleaning


---

class: center, middle, inverse

# Getting started


---

# What is data wrangling?

.pull-left[
- "data janitor work"
- importing data
- cleaning data
- changing shape of data
]
.pull-right[
- fixing errors and poorly formatted data elements
- transforming columns and rows
- filtering, subsetting
]

&lt;img src="img/r4ds_tidyverse.png" width="80%" height="80%"&gt;

[G. Grolemond &amp; H. Wickham's R for Data Science](https://r4ds.had.co.nz/introduction.html)

---

# Good practices in Rstudio

- Use "projects" ([read this](https://r4ds.had.co.nz/workflow-projects.html))
    + Create an RStudio project for each data analysis project.
    + Keep data files there; we’ll talk about loading them into R in data import.
    + Keep scripts there; edit them, run them in bits or as a whole.
    + Save your outputs (plots and cleaned data) there.
- Only ever use relative paths, not absolute paths.
    + i.e. `read_csv("data/mydata.csv")` not `read_csv("/home/yourname/Documents/stuff/this file is where again FINAL.csv")`
    
Projects standardize file paths, keep everything together, whole folder can be shared and run in another place.


---

# Rstudio Projects

## New new project

- Open Rstudio
- File -&gt; New Project

## Existing project

- click on `.Rproj` file in your folder

---

# Useful keyboard shortcuts

.pull-left[
action | mac | windows/linux
---| ---| ---
run line of code | cmd+enter | ctrl+enter 
`&lt;-`| option + - | alt+ -
`%&gt;%` | cmd+shift+m | ctrl+shift+m
]
.pull-right[
Try typing and running

```r
y &lt;- iris %&gt;% count(Species)
y
```

Now, in console, press up arrow multiple times.

]
## Others: ([see list](https://support.rstudio.com/hc/en-us/articles/200711853-Keyboard-Shortcuts))

action | mac | windows/linux
---| ---| ---
interrupt currently executing command | esc | esc
in console, go to previously run code | up/down | up/down
keyboard shortcut help | option+shift+k | alt+shift+k


---

# Tibbles

.pull-left[
We learned about *data frames*

```r
data.frame(name = c("Sarah","Ana","Jose"), 
           rank = 1:3,
           age = c(35.5, 25, 58),
           city = c(NA,"New York","LA"))
```

```
   name rank  age     city
1 Sarah    1 35.5     &lt;NA&gt;
2   Ana    2 25.0 New York
3  Jose    3 58.0       LA
```
]
.pull-right[
A *tibble* is a data frame but with perks

```r
tibble(name = c("Sarah","Ana","Jose"), 
       rank = 1:3,
       age = c(35.5, 25, 58),
       city = c(NA,"New York","LA"))
```

```
# A tibble: 3 x 4
  name   rank   age city    
  &lt;chr&gt; &lt;int&gt; &lt;dbl&gt; &lt;chr&gt;   
1 Sarah     1  35.5 &lt;NA&gt;    
2 Ana       2  25   New York
3 Jose      3  58   LA      
```
]


---

# Tibble perks

- better printing methods
- doesn't print 10000 rows
- tells you the variable type (character, factor, double, integer, boolean, date)
- can be used anywhere a `data.frame` is needed
- `read_*()` functions don't read character columns as factors (no surprises)

---

# Import as `data.frame` (try this)


Base R functions import `data.frame`


```r
mydata_df &lt;- read.csv("data/small_data.csv")
mydata_df
```

```
        id                   age    sex grade                     race4
1   335340          17 years old Female  10th                     White
2   638618          16 years old Female   9th                      &lt;NA&gt;
3   922382          14 years old   Male   9th                     White
4   923122          15 years old   Male   9th                     White
5   923963          15 years old   Male  10th Black or African American
6   925603          16 years old   Male  10th           All other races
7   933724          16 years old Female  10th           All other races
8   935435          17 years old Female  12th           All other races
9  1096564          15 years old   Male  10th           All other races
10 1108114          17 years old Female   9th Black or African American
11 1306150          16 years old   Male  10th           Hispanic/Latino
12 1307481          17 years old   Male  12th           Hispanic/Latino
13 1307872          17 years old   Male  11th           Hispanic/Latino
14 1311617          15 years old Female  10th           Hispanic/Latino
15 1313153          16 years old Female  11th           Hispanic/Latino
16 1313291          16 years old Female  11th                     White
17 1313477          16 years old Female  10th           All other races
18 1315121          17 years old Female  11th                      &lt;NA&gt;
19 1315850          17 years old Female  12th           Hispanic/Latino
20 1316123 18 years old or older Female  12th Black or African American
       bmi weight_kg           text_while_driving_30d smoked_ever
1  27.5671     66.23                             &lt;NA&gt;        &lt;NA&gt;
2  29.3495     84.82                             &lt;NA&gt;         Yes
3  18.1827     57.61                             &lt;NA&gt;         Yes
4  21.3754     60.33                             &lt;NA&gt;         Yes
5  19.5988     63.50                             &lt;NA&gt;          No
6  22.1910     70.31                             &lt;NA&gt;          No
7  20.9913     45.36                             &lt;NA&gt;         Yes
8  17.4814     43.09                             &lt;NA&gt;          No
9  22.4593     79.38                             &lt;NA&gt;        &lt;NA&gt;
10 26.5781     68.04                             &lt;NA&gt;          No
11 21.1874     67.13                           0 days        &lt;NA&gt;
12 19.4637     56.25                      1 or 2 days          No
13 20.6121     61.69                      1 or 2 days          No
14 27.4648     70.31                           0 days          No
15 26.5781     68.04                           0 days          No
16 24.8047     63.50                      3 to 5 days          No
17 25.0318     76.66                           0 days          No
18 22.2687     54.89 I did not drive the past 30 days         Yes
19 19.4922     49.90                           0 days        &lt;NA&gt;
20 27.4894     74.84                      All 30 days         Yes
   bullied_past_12mo height_m
1                 NA 1.550000
2                 NA 1.699999
3              FALSE 1.779999
4              FALSE 1.680001
5               TRUE 1.799998
6               TRUE 1.780000
7               TRUE 1.469998
8              FALSE 1.570002
9               TRUE 1.879998
10             FALSE 1.600001
11             FALSE 1.779998
12             FALSE 1.699999
13             FALSE 1.730001
14              TRUE 1.600001
15              TRUE 1.600001
16             FALSE 1.600000
17              TRUE 1.750001
18             FALSE 1.569998
19             FALSE 1.599999
20             FALSE 1.650001
```

---

# Import as `tibble` (try this)

`tidyverse` functions import as tibbles (`read_csv`, `read_excel()`, etc)


```r
mydata_tib &lt;- read_csv("data/small_data.csv")
mydata_tib
```

```
# A tibble: 20 x 11
       id age   sex   grade race4   bmi weight_kg text_while_driv…
    &lt;dbl&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;dbl&gt;     &lt;dbl&gt; &lt;chr&gt;           
 1 3.35e5 17 y… Fema… 10th  White  27.6      66.2 &lt;NA&gt;            
 2 6.39e5 16 y… Fema… 9th   &lt;NA&gt;   29.3      84.8 &lt;NA&gt;            
 3 9.22e5 14 y… Male  9th   White  18.2      57.6 &lt;NA&gt;            
 4 9.23e5 15 y… Male  9th   White  21.4      60.3 &lt;NA&gt;            
 5 9.24e5 15 y… Male  10th  Blac…  19.6      63.5 &lt;NA&gt;            
 6 9.26e5 16 y… Male  10th  All …  22.2      70.3 &lt;NA&gt;            
 7 9.34e5 16 y… Fema… 10th  All …  21.0      45.4 &lt;NA&gt;            
 8 9.35e5 17 y… Fema… 12th  All …  17.5      43.1 &lt;NA&gt;            
 9 1.10e6 15 y… Male  10th  All …  22.5      79.4 &lt;NA&gt;            
10 1.11e6 17 y… Fema… 9th   Blac…  26.6      68.0 &lt;NA&gt;            
11 1.31e6 16 y… Male  10th  Hisp…  21.2      67.1 0 days          
12 1.31e6 17 y… Male  12th  Hisp…  19.5      56.2 1 or 2 days     
13 1.31e6 17 y… Male  11th  Hisp…  20.6      61.7 1 or 2 days     
14 1.31e6 15 y… Fema… 10th  Hisp…  27.5      70.3 0 days          
15 1.31e6 16 y… Fema… 11th  Hisp…  26.6      68.0 0 days          
16 1.31e6 16 y… Fema… 11th  White  24.8      63.5 3 to 5 days     
17 1.31e6 16 y… Fema… 10th  All …  25.0      76.7 0 days          
18 1.32e6 17 y… Fema… 11th  &lt;NA&gt;   22.3      54.9 I did not drive…
19 1.32e6 17 y… Fema… 12th  Hisp…  19.5      49.9 0 days          
20 1.32e6 18 y… Fema… 12th  Blac…  27.5      74.8 All 30 days     
# … with 3 more variables: smoked_ever &lt;chr&gt;, bullied_past_12mo &lt;lgl&gt;,
#   height_m &lt;dbl&gt;
```

---

# Run this code




---

# Tidy Data

1. Each variable forms a column.
2. Each observation forms a row.
3. Each type of observational unit forms a table.

![](img/r4ds_tidy_data.png)
[G. Grolemond &amp; H. Wickham's R for Data Science](https://r4ds.had.co.nz/introduction.html)

---

# Untidy data: example 1


```r
untidy_data &lt;- tibble(
  name = c("Ana","Bob","Cara"),
  wt_07_01_2018 = c(100, 150, 140),
  wt_08_01_2018 = c(104, 155, 138),
  wt_09_01_2018 = c(NA, 160, 142)
)
untidy_data
```

```
# A tibble: 3 x 4
  name  wt_07_01_2018 wt_08_01_2018 wt_09_01_2018
  &lt;chr&gt;         &lt;dbl&gt;         &lt;dbl&gt;         &lt;dbl&gt;
1 Ana             100           104            NA
2 Bob             150           155           160
3 Cara            140           138           142
```



---

# Tidy data: example 1

You will learn how to do this!

```r
untidy_data %&gt;% gather(key = "date", value = "weight", -name) %&gt;%
  mutate(date = str_replace(date,"wt_",""),
         date = dmy(date))
```

```
# A tibble: 9 x 3
  name  date       weight
  &lt;chr&gt; &lt;date&gt;      &lt;dbl&gt;
1 Ana   2018-01-07    100
2 Bob   2018-01-07    150
3 Cara  2018-01-07    140
4 Ana   2018-01-08    104
5 Bob   2018-01-08    155
6 Cara  2018-01-08    138
7 Ana   2018-01-09     NA
8 Bob   2018-01-09    160
9 Cara  2018-01-09    142
```

---

# Untidy data: example 2


```r
untidy_data &lt;- tibble(
  name = c("Ana","Bob","Cara"),
  meds = c("advil 500mg 2xday","tylenol 1000mg 1xday", "advil 200mg 3xday")
)
untidy_data
```

```
# A tibble: 3 x 2
  name  meds                
  &lt;chr&gt; &lt;chr&gt;               
1 Ana   advil 500mg 2xday   
2 Bob   tylenol 1000mg 1xday
3 Cara  advil 200mg 3xday   
```

---

# Tidy data: example 2

You will learn how to do this!

```r
untidy_data %&gt;% 
  separate(col = meds, into = c("med_name","dose_mg","times_per_day"), sep=" ") %&gt;%
  mutate(times_per_day = as.numeric(str_replace(times_per_day, "xday", "")),
         dose_mg = as.numeric(str_replace(dose_mg, "mg","")))
```

```
# A tibble: 3 x 4
  name  med_name dose_mg times_per_day
  &lt;chr&gt; &lt;chr&gt;      &lt;dbl&gt;         &lt;dbl&gt;
1 Ana   advil        500             2
2 Bob   tylenol     1000             1
3 Cara  advil        200             3
```

---

class: center, middle, inverse

# How to tidy?

---

# The pipe operator `%&gt;%`

- a function performed on (usually) a data frame or tibble used somewhat like a `+`
- "add" functions together
- the result is a transformed data set as a `tibble`
- Suppose you want to perform a series of operations on a data.frame or tibble `mydata` using hypothetical functions `f()`, `g()`, `h()`:
    + Perform `f(mydata)`
    + use the output as an argument to `g()`
    + use the output as an argument to `h()`

.pull-left[
One option:


```r
h(g(f(mydata)))
```
]
.pull-right[

A long tedious option:


```r
fout &lt;- f(mydata)
gout &lt;- g(fout)
h(gout)
```
]

---

# Use the pipe `%&gt;%`

Instead, we can use the pipe operator (pronounced "then")

- Take `mydata` then
- perform `f()` then
- perform `g()` then
- perform `h()`


```r
mydata %&gt;% 
  f() %&gt;% 
  g() %&gt;% 
  h()
```

---

# Why use the pipe?

- makes code more readable
- `h(f(g(mydata)))` can get complicated with multiple arguments
    + i.e. `h(f(g(mydata, na.rm=T), print=FALSE), type = "mean")`

A real example:

```r
mydata_new &lt;- mydata %&gt;% select(id, weight_kg, bmi) %&gt;%
  mutate(height_m = sqrt(weight_kg /bmi))
mydata_new %&gt;% head(n=3)
```

```
# A tibble: 3 x 4
      id weight_kg   bmi height_m
   &lt;dbl&gt;     &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt;
1 335340      66.2  27.6     1.55
2 638618      84.8  29.3     1.70
3 922382      57.6  18.2     1.78
```

---
class: center, inverse, middle

# Let's wrangle!

---

# About the data

Data from the CDC's [Youth Risk Behavior Surveillance System (YRBSS) ](https://www.cdc.gov/healthyyouth/data/yrbs/index.htm)

- complex survey data
- national school-based survey conducted by CDC and state, territorial, tribal, and local surveys conducted by state, territorial, and local education and health agencies and tribal governments
- monitors six categories of health-related behaviors that contribute to the leading causes of death and disability among youth and adults (including alcohol &amp; drug use, unhealthy &amp; dangerous behaviors, sexuality, physical activity); see [Questionnaires](https://www.cdc.gov/healthyyouth/data/yrbs/questionnaires.htm)
- this data is a subset of data in the R package [`yrbss`](https://github.com/hadley/yrbss) which includes YRBSS from 1991-2013

---

# Import Data

Run this in your project



Look at your "Environment" tab, you should have the data there.

---

# Tidyverse functions

- `tidyverse` is a suite of packages that implement `tidy` methods for data importing, cleaning and wrangling 
- functions like `filter()`, `select()`, `mutate()` are part of the `tidyverse`
    + first argument is always the data frame
    + can be used in pipes `%&gt;%`

.pull-left[
All equivalent:

```r
select(.data = demo_data, "record")
select(demo_data, "record")
select(demo_data, record)
demo_data %&gt;% select(record)
```
]
.pull-right[
Output:

```
# A tibble: 40,068 x 1
    record
     &lt;dbl&gt;
 1  506901
 2  635425
 3  506905
 4 1102227
 5   36586
 6  767512
 7  506907
 8  930386
 9 1310476
10  930393
# … with 40,058 more rows
```
]

---

class: center, middle, inverse

# Subsetting data

---

# Subset by rows

&lt;img src="img/datawrangle_cheatsheet_subset_rows.png" width="100%" height="100%"&gt;
[tidyverse data wrangling cheatsheet](https://www.rstudio.com/wp-content/uploads/2015/02/data-wrangling-cheatsheet.pdf)

---

# `filter()` `\(\sim\)` rows

- filter data based on rows
- use logical cues:
    + double = for "is equal to"
    + use `&amp;` (and) or `|` (or)
    + `!` in front negates the statement, as in `!=` or `!(grade=="9th")`
- use math
    + `&gt;` `&lt;` `&gt;=` `&lt;=`
- use the `is.na()` function to filter based on missing values


```r
demo_data %&gt;% filter(bmi &gt; 20)
```

```
# A tibble: 20,818 x 8
    record age           sex   grade race4     race7           bmi stweight
     &lt;dbl&gt; &lt;chr&gt;         &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;     &lt;chr&gt;         &lt;dbl&gt;    &lt;dbl&gt;
 1  506901 12 years old… Fema… 9th   All othe… Am Indian / …  23.9     69.0
 2 1310476 12 years old… Fema… 9th   Hispanic… Hispanic/Lat…  28       90.7
 3  767508 12 years old… Fema… 9th   Hispanic… Hispanic/Lat…  29.9     79.4
 4  930385 12 years old… Fema… 9th   Hispanic… Hispanic/Lat…  35.9     95.3
 5  767513 12 years old… Fema… 9th   Hispanic… Hispanic/Lat…  31.4     90.7
 6 1102222 12 years old… Fema… 10th  Hispanic… Hispanic/Lat…  31.2    104. 
 7 1102223 12 years old… Fema… 11th  Hispanic… Hispanic/Lat…  22.8     65.8
 8  402813 12 years old… Fema… 12th  Hispanic… Hispanic/Lat…  32.0     45.4
 9  767510 12 years old… Fema… 12th  White     White          20.0     63.5
10 1310484 12 years old… Fema… &lt;NA&gt;  Hispanic… Hispanic/Lat…  24.3     70.3
# … with 20,808 more rows
```

---

# `filter()` practice

What do these commands do? Try:


```r
demo_data %&gt;% filter(record==506901)
demo_data %&gt;% filter(sex=="Male")
demo_data %&gt;% filter(grade %in% c("10th","11th"))
demo_data %&gt;% filter(!(grade=="9th"))
demo_data %&gt;% filter(bmi &lt; 20, stweight &lt; 50, sex=="Female") # filter on multiple
demo_data %&gt;% filter(is.na(bmi))
demo_data %&gt;% filter(!is.na(bmi))
demo_data %&gt;% filter(bmi &lt; 5)
demo_data %&gt;% filter(bmi/stweight &lt; 0.5) # can do math
demo_data %&gt;% filter((bmi&lt;15)|(bmi&gt;50))
```

---

# Subset by columns

&lt;img src="img/datawrangle_cheatsheet_subset_cols.png" width="100%" height="100%"&gt;
[tidyverse data wrangling cheatsheet](https://www.rstudio.com/wp-content/uploads/2015/02/data-wrangling-cheatsheet.pdf)

---

# `select()` `\(\sim\)` columns

- select columns/variables
- uses special syntax: `var1:var20`, `one_of(c("a","b","c"))`, `-var1`, `contains("date")`
- can be used to rearrange columns (useful to use `everything()`)


```r
demo_data %&gt;% select(record, grade)
```

```
# A tibble: 40,068 x 2
    record grade
     &lt;dbl&gt; &lt;chr&gt;
 1  506901 9th  
 2  635425 9th  
 3  506905 9th  
 4 1102227 9th  
 5   36586 9th  
 6  767512 9th  
 7  506907 9th  
 8  930386 9th  
 9 1310476 9th  
10  930393 9th  
# … with 40,058 more rows
```

---

# `select()` practice

What do these commands do? Try:


```r
demo_data %&gt;% select(-grade,-sex)
```

```
# A tibble: 40,068 x 6
    record age             race4            race7              bmi stweight
     &lt;dbl&gt; &lt;chr&gt;           &lt;chr&gt;            &lt;chr&gt;            &lt;dbl&gt;    &lt;dbl&gt;
 1  506901 12 years old o… All other races  Am Indian / Ala…  23.9     69.0
 2  635425 12 years old o… All other races  Am Indian / Ala…  NA       NA  
 3  506905 12 years old o… All other races  Am Indian / Ala…  NA       NA  
 4 1102227 12 years old o… All other races  Asian             NA       NA  
 5   36586 12 years old o… Black or Africa… Black or Africa…  NA       NA  
 6  767512 12 years old o… Black or Africa… Black or Africa…  NA       NA  
 7  506907 12 years old o… Black or Africa… Black or Africa…  NA       NA  
 8  930386 12 years old o… Black or Africa… Black or Africa…  NA       NA  
 9 1310476 12 years old o… Hispanic/Latino  Hispanic/Latino   28       90.7
10  930393 12 years old o… Hispanic/Latino  Hispanic/Latino   NA       NA  
# … with 40,058 more rows
```

```r
demo_data %&gt;% select(record:sex)
```

```
# A tibble: 40,068 x 3
    record age                     sex   
     &lt;dbl&gt; &lt;chr&gt;                   &lt;chr&gt; 
 1  506901 12 years old or younger Female
 2  635425 12 years old or younger Female
 3  506905 12 years old or younger Female
 4 1102227 12 years old or younger Female
 5   36586 12 years old or younger Female
 6  767512 12 years old or younger Female
 7  506907 12 years old or younger Female
 8  930386 12 years old or younger Female
 9 1310476 12 years old or younger Female
10  930393 12 years old or younger Female
# … with 40,058 more rows
```

```r
demo_data %&gt;% select(-(record:sex))
```

```
# A tibble: 40,068 x 5
   grade race4                     race7                       bmi stweight
   &lt;chr&gt; &lt;chr&gt;                     &lt;chr&gt;                     &lt;dbl&gt;    &lt;dbl&gt;
 1 9th   All other races           Am Indian / Alaska Native  23.9     69.0
 2 9th   All other races           Am Indian / Alaska Native  NA       NA  
 3 9th   All other races           Am Indian / Alaska Native  NA       NA  
 4 9th   All other races           Asian                      NA       NA  
 5 9th   Black or African American Black or African American  NA       NA  
 6 9th   Black or African American Black or African American  NA       NA  
 7 9th   Black or African American Black or African American  NA       NA  
 8 9th   Black or African American Black or African American  NA       NA  
 9 9th   Hispanic/Latino           Hispanic/Latino            28       90.7
10 9th   Hispanic/Latino           Hispanic/Latino            NA       NA  
# … with 40,058 more rows
```

```r
demo_data %&gt;% select(contains("race"))
```

```
# A tibble: 40,068 x 2
   race4                     race7                    
   &lt;chr&gt;                     &lt;chr&gt;                    
 1 All other races           Am Indian / Alaska Native
 2 All other races           Am Indian / Alaska Native
 3 All other races           Am Indian / Alaska Native
 4 All other races           Asian                    
 5 Black or African American Black or African American
 6 Black or African American Black or African American
 7 Black or African American Black or African American
 8 Black or African American Black or African American
 9 Hispanic/Latino           Hispanic/Latino          
10 Hispanic/Latino           Hispanic/Latino          
# … with 40,058 more rows
```

```r
demo_data %&gt;% select(record, race4, race7, everything())
```

```
# A tibble: 40,068 x 8
    record race4        race7        age         sex   grade   bmi stweight
     &lt;dbl&gt; &lt;chr&gt;        &lt;chr&gt;        &lt;chr&gt;       &lt;chr&gt; &lt;chr&gt; &lt;dbl&gt;    &lt;dbl&gt;
 1  506901 All other r… Am Indian /… 12 years o… Fema… 9th    23.9     69.0
 2  635425 All other r… Am Indian /… 12 years o… Fema… 9th    NA       NA  
 3  506905 All other r… Am Indian /… 12 years o… Fema… 9th    NA       NA  
 4 1102227 All other r… Asian        12 years o… Fema… 9th    NA       NA  
 5   36586 Black or Af… Black or Af… 12 years o… Fema… 9th    NA       NA  
 6  767512 Black or Af… Black or Af… 12 years o… Fema… 9th    NA       NA  
 7  506907 Black or Af… Black or Af… 12 years o… Fema… 9th    NA       NA  
 8  930386 Black or Af… Black or Af… 12 years o… Fema… 9th    NA       NA  
 9 1310476 Hispanic/La… Hispanic/La… 12 years o… Fema… 9th    28       90.7
10  930393 Hispanic/La… Hispanic/La… 12 years o… Fema… 9th    NA       NA  
# … with 40,058 more rows
```

```r
demo_data %&gt;% select(one_of(c("age","stweight")))
```

```
# A tibble: 40,068 x 2
   age                     stweight
   &lt;chr&gt;                      &lt;dbl&gt;
 1 12 years old or younger     69.0
 2 12 years old or younger     NA  
 3 12 years old or younger     NA  
 4 12 years old or younger     NA  
 5 12 years old or younger     NA  
 6 12 years old or younger     NA  
 7 12 years old or younger     NA  
 8 12 years old or younger     NA  
 9 12 years old or younger     90.7
10 12 years old or younger     NA  
# … with 40,058 more rows
```

```r
demo_data %&gt;% select(starts_with("r"))
```

```
# A tibble: 40,068 x 3
    record race4                     race7                    
     &lt;dbl&gt; &lt;chr&gt;                     &lt;chr&gt;                    
 1  506901 All other races           Am Indian / Alaska Native
 2  635425 All other races           Am Indian / Alaska Native
 3  506905 All other races           Am Indian / Alaska Native
 4 1102227 All other races           Asian                    
 5   36586 Black or African American Black or African American
 6  767512 Black or African American Black or African American
 7  506907 Black or African American Black or African American
 8  930386 Black or African American Black or African American
 9 1310476 Hispanic/Latino           Hispanic/Latino          
10  930393 Hispanic/Latino           Hispanic/Latino          
# … with 40,058 more rows
```

```r
demo_data %&gt;% select(-contains("r"))
```

```
# A tibble: 40,068 x 4
   age                     sex      bmi stweight
   &lt;chr&gt;                   &lt;chr&gt;  &lt;dbl&gt;    &lt;dbl&gt;
 1 12 years old or younger Female  23.9     69.0
 2 12 years old or younger Female  NA       NA  
 3 12 years old or younger Female  NA       NA  
 4 12 years old or younger Female  NA       NA  
 5 12 years old or younger Female  NA       NA  
 6 12 years old or younger Female  NA       NA  
 7 12 years old or younger Female  NA       NA  
 8 12 years old or younger Female  NA       NA  
 9 12 years old or younger Female  28       90.7
10 12 years old or younger Female  NA       NA  
# … with 40,058 more rows
```

```r
demo_data %&gt;% select(1:3)
```

```
# A tibble: 40,068 x 3
    record age                     sex   
     &lt;dbl&gt; &lt;chr&gt;                   &lt;chr&gt; 
 1  506901 12 years old or younger Female
 2  635425 12 years old or younger Female
 3  506905 12 years old or younger Female
 4 1102227 12 years old or younger Female
 5   36586 12 years old or younger Female
 6  767512 12 years old or younger Female
 7  506907 12 years old or younger Female
 8  930386 12 years old or younger Female
 9 1310476 12 years old or younger Female
10  930393 12 years old or younger Female
# … with 40,058 more rows
```


---

# `rename()` `\(\sim\)` columns

- renames column variables


```r
demo_data %&gt;% rename(id = record)
```

```
# A tibble: 40,068 x 8
        id age         sex   grade race4        race7          bmi stweight
     &lt;dbl&gt; &lt;chr&gt;       &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;        &lt;chr&gt;        &lt;dbl&gt;    &lt;dbl&gt;
 1  506901 12 years o… Fema… 9th   All other r… Am Indian /…  23.9     69.0
 2  635425 12 years o… Fema… 9th   All other r… Am Indian /…  NA       NA  
 3  506905 12 years o… Fema… 9th   All other r… Am Indian /…  NA       NA  
 4 1102227 12 years o… Fema… 9th   All other r… Asian         NA       NA  
 5   36586 12 years o… Fema… 9th   Black or Af… Black or Af…  NA       NA  
 6  767512 12 years o… Fema… 9th   Black or Af… Black or Af…  NA       NA  
 7  506907 12 years o… Fema… 9th   Black or Af… Black or Af…  NA       NA  
 8  930386 12 years o… Fema… 9th   Black or Af… Black or Af…  NA       NA  
 9 1310476 12 years o… Fema… 9th   Hispanic/La… Hispanic/La…  28       90.7
10  930393 12 years o… Fema… 9th   Hispanic/La… Hispanic/La…  NA       NA  
# … with 40,058 more rows
```

---

# `select_*()` and `rename_*()` practice

- scoped variants of `select()` and `rename()` operate on a selection of columns
- which columns depends on a predicate, can be:
    + variable names through `vars()`, or
    + a function that returns TRUE/FALSE like `is.numeric()`

What do these commands do? Try:


```r
demo_data %&gt;% select_if(is.numeric)
demo_data %&gt;% rename_if(is.character, toupper) # toupper() is a function
demo_data %&gt;% rename_all(toupper)
demo_data %&gt;% rename_at(vars(contains("race")), toupper)
demo_data %&gt;% rename_if(is.numeric, funs(paste0(.,"_num")))
```


---

# Practice

1. Import `demo_data.csv` in the `data/` folder
1. Convert all column names to upper case, save the result as `newdata`
1. For `newdata`, select only character variables, save again as `newdata`.
1. Filter this data to only keep Asian or Native Hawaiian/other PI subjects in the 9th grade.
1. Filter this data to remove subjects younger than 13.
1. Remove the column `RACE4`.
1. How many rows does the resulting `newdata` have? How many columns?




---

class: center, middle, inverse

# Changing the data

---

# Make new variables

&lt;img src="img/datawrangle_cheatsheet_makenewvars.png" width="100%" height="100%"&gt;
[tidyverse data wrangling cheatsheet](https://www.rstudio.com/wp-content/uploads/2015/02/data-wrangling-cheatsheet.pdf)


---

# `mutate()`

EXPLAIN MUTATE


```r
newdata &lt;- demo_data %&gt;% 
  select(record, bmi:stweight) %&gt;%
  mutate(height_m = sqrt(stweight /bmi))
newdata
```

```
# A tibble: 40,068 x 4
    record   bmi stweight height_m
     &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;
 1  506901  23.9     69.0     1.70
 2  635425  NA       NA      NA   
 3  506905  NA       NA      NA   
 4 1102227  NA       NA      NA   
 5   36586  NA       NA      NA   
 6  767512  NA       NA      NA   
 7  506907  NA       NA      NA   
 8  930386  NA       NA      NA   
 9 1310476  28       90.7     1.8 
10  930393  NA       NA      NA   
# … with 40,058 more rows
```

---

# `mutate()` practice

Try these:


```r
demo_data %&gt;% mutate(bmi_high = bmi &gt; 30)
demo_data %&gt;% mutate(male = 1*(sex=="Male"))
demo_data %&gt;% mutate(grade_num = as.numeric(str_replace(grade,"th","")))
```

---

# `case_when()` with `mutate()`

EXPLAIN CASE WHEN


```r
demo_data2 &lt;- demo_data %&gt;%
  mutate(
    age_int = case_when(
      age=="12 years old or younger" ~ 12,
      age=="18 years old or older" ~ 18,
      TRUE ~ as.numeric(str_replace(age, " years old",""))
  ))
demo_data2 %&gt;% tabyl(age,age_int)
```

```
                     age  12  13   14   15    16    17   18 NA_
 12 years old or younger 241   0    0    0     0     0    0   0
            13 years old   0 193    0    0     0     0    0   0
            14 years old   0   0 4101    0     0     0    0   0
            15 years old   0   0    0 8507     0     0    0   0
            16 years old   0   0    0    0 10019     0    0   0
            17 years old   0   0    0    0     0 10029    0   0
   18 years old or older   0   0    0    0     0     0 6550   0
                    &lt;NA&gt;   0   0    0    0     0     0    0 428
```

---

# `separate()` and `unite()`

---

# Dealing with missing or duplicated data


```r
demo_data %&gt;% distinct()
```

```
# A tibble: 40,068 x 8
    record age         sex   grade race4        race7          bmi stweight
     &lt;dbl&gt; &lt;chr&gt;       &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;        &lt;chr&gt;        &lt;dbl&gt;    &lt;dbl&gt;
 1  506901 12 years o… Fema… 9th   All other r… Am Indian /…  23.9     69.0
 2  635425 12 years o… Fema… 9th   All other r… Am Indian /…  NA       NA  
 3  506905 12 years o… Fema… 9th   All other r… Am Indian /…  NA       NA  
 4 1102227 12 years o… Fema… 9th   All other r… Asian         NA       NA  
 5   36586 12 years o… Fema… 9th   Black or Af… Black or Af…  NA       NA  
 6  767512 12 years o… Fema… 9th   Black or Af… Black or Af…  NA       NA  
 7  506907 12 years o… Fema… 9th   Black or Af… Black or Af…  NA       NA  
 8  930386 12 years o… Fema… 9th   Black or Af… Black or Af…  NA       NA  
 9 1310476 12 years o… Fema… 9th   Hispanic/La… Hispanic/La…  28       90.7
10  930393 12 years o… Fema… 9th   Hispanic/La… Hispanic/La…  NA       NA  
# … with 40,058 more rows
```

Removes *all* rows with *any* missing (`NA`) values in *any* row


```r
demo_data %&gt;% na.omit()
```

```
# A tibble: 25,948 x 8
    record age         sex   grade race4        race7          bmi stweight
     &lt;dbl&gt; &lt;chr&gt;       &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;        &lt;chr&gt;        &lt;dbl&gt;    &lt;dbl&gt;
 1  506901 12 years o… Fema… 9th   All other r… Am Indian /…  23.9     69.0
 2 1310476 12 years o… Fema… 9th   Hispanic/La… Hispanic/La…  28       90.7
 3  767508 12 years o… Fema… 9th   Hispanic/La… Hispanic/La…  29.9     79.4
 4  930385 12 years o… Fema… 9th   Hispanic/La… Hispanic/La…  35.9     95.3
 5  767513 12 years o… Fema… 9th   Hispanic/La… Hispanic/La…  31.4     90.7
 6 1102222 12 years o… Fema… 10th  Hispanic/La… Hispanic/La…  31.2    104. 
 7 1102231 12 years o… Fema… 10th  Hispanic/La… Hispanic/La…  18.7     50.8
 8 1102233 12 years o… Fema… 11th  Black or Af… Black or Af…  19.4     58.1
 9 1102223 12 years o… Fema… 11th  Hispanic/La… Hispanic/La…  22.8     65.8
10  402813 12 years o… Fema… 12th  Hispanic/La… Hispanic/La…  32.0     45.4
# … with 25,938 more rows
```



---

class: center, middle, inverse

# Joining/merging data


---

# Resources - R Basics

- [RStudio IDE Cheatsheet](https://resources.rstudio.com/rstudio-cheatsheets/rstudio-ide-cheat-sheet)
- Install R/RStudio [help video](https://www.youtube.com/watch?v=kOQDdJZ7Hl4&amp;feature=youtu.be)
- [Basic Basics](http://rladiessydney.org/post/2018/11/05/basicbasics/)

Interactive lessons

- [DataCamp](www.datacamp.com)
    + [Introduction to R (free course)](https://www.datacamp.com/courses/free-introduction-to-r)
    + [Introduction to the Tidyverse](https://www.datacamp.com/courses/introduction-to-the-tidyverse)
    + [Intermediate R](https://www.datacamp.com/courses/intermediate-r)

Online books/lessons:

- [Intro to R/RStudio](http://www-users.york.ac.uk/~er13/17C%20-%202018/pracs/01IntroductionToModuleAndRStudio.html) by Emma Rand
- [Modern Dive](https://moderndive.com/) - An Introduction to Statistical and Data Sciences via R by Chester Ismay &amp; Albert Kim
- [Cookbook for R](http://www.cookbook-r.com/) by Winston Chang

---

# Resources - Tidyverse &amp; Data Wrangling

Links

- [Learn the tidyverse](https://www.tidyverse.org/learn/)
- [Data wrangling cheatsheet](https://www.rstudio.com/wp-content/uploads/2015/02/data-wrangling-cheatsheet.pdf)

Interactive lessons

- [DataCamp](www.datacamp.com)
    + [Introduction to the Tidyverse](https://www.datacamp.com/courses/introduction-to-the-tidyverse)
    + [Intermediate R](https://www.datacamp.com/courses/intermediate-r)

Some of this is drawn from materials in online books/lessons:

- [R for Data Science](https://r4ds.had.co.nz/index.html) - by Garrett Grolemund &amp; Hadley Wickham
- [Modern Dive](https://moderndive.com/) - An Introduction to Statistical and Data Sciences via R by Chester Ismay &amp; Albert Kim
- [A gRadual intRoduction to the tidyverse](https://github.com/Cascadia-R/gRadual-intRoduction-tidyverse) - Workshop for Cascadia R 2017 by Chester Ismay and Ted Laderas
- [Cookbook for R](http://www.cookbook-r.com/) by Winston Chang
- ["Tidy Data" by Hadley Wickham](https://vita.had.co.nz/papers/tidy-data.pdf)
---

# Possible Future Workshop Topics?

- reproducible reports in R
- tables
- ggplot2 visualization
- advanced tidyverse: functions, purrr
- statistical modeling in R

---

## Contact info:

Jessica Minnier: _minnier@ohsu.edu_

Meike Niederhausen: _niederha@ohsu.edu_


## This workshop info:

- Code for these slides on github: [jminnier/berd_r_courses](https://github.com/jminnier/berd_r_courses)
- all the [R code in an R script](https://jminnier-berd-r-courses.netlify.com/02-data-wrangling-tidyverse/02_data_wrangling_slides.R)
- answers to practice problems can be found here: [html](https://jminnier-berd-r-courses.netlify.com/02-data-wrangling-tidyverse/02_data_wrangling_slides_practice_answers.html), [pdf](https://jminnier-berd-r-courses.netlify.com/02-data-wrangling-tidyverse/02_data_wrangling_slides_practice_answers.pdf)
    </textarea>
<style data-target="print-only">@media screen {.remark-slide-container{display:block;}.remark-slide-scaler{box-shadow:none;}}</style>
<script src="https://remarkjs.com/downloads/remark-latest.min.js"></script>
<script>var slideshow = remark.create({
"highlightStyle": "tomorrow",
"highlightLines": true,
"highlightLanguage": "r",
"countIncrementalSlides": false,
"ratio": "16:9"
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {
  window.dispatchEvent(new Event('resize'));
});
(function(d) {
  var s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler");
  if (!r) return;
  s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }";
  d.head.appendChild(s);
})(document);

(function(d) {
  var el = d.getElementsByClassName("remark-slides-area");
  if (!el) return;
  var slide, slides = slideshow.getSlides(), els = el[0].children;
  for (var i = 1; i < slides.length; i++) {
    slide = slides[i];
    if (slide.properties.continued === "true" || slide.properties.count === "false") {
      els[i - 1].className += ' has-continuation';
    }
  }
  var s = d.createElement("style");
  s.type = "text/css"; s.innerHTML = "@media print { .has-continuation { display: none; } }";
  d.head.appendChild(s);
})(document);
// delete the temporary CSS (for displaying all slides initially) when the user
// starts to view slides
(function() {
  var deleted = false;
  slideshow.on('beforeShowSlide', function(slide) {
    if (deleted) return;
    var sheets = document.styleSheets, node;
    for (var i = 0; i < sheets.length; i++) {
      node = sheets[i].ownerNode;
      if (node.dataset["target"] !== "print-only") continue;
      node.parentNode.removeChild(node);
    }
    deleted = true;
  });
})();</script>

<script>
(function() {
  var links = document.getElementsByTagName('a');
  for (var i = 0; i < links.length; i++) {
    if (/^(https?:)?\/\//.test(links[i].getAttribute('href'))) {
      links[i].target = '_blank';
    }
  }
})();
</script>

<script>
slideshow._releaseMath = function(el) {
  var i, text, code, codes = el.getElementsByTagName('code');
  for (i = 0; i < codes.length;) {
    code = codes[i];
    if (code.parentNode.tagName !== 'PRE' && code.childElementCount === 0) {
      text = code.textContent;
      if (/^\\\((.|\s)+\\\)$/.test(text) || /^\\\[(.|\s)+\\\]$/.test(text) ||
          /^\$\$(.|\s)+\$\$$/.test(text) ||
          /^\\begin\{([^}]+)\}(.|\s)+\\end\{[^}]+\}$/.test(text)) {
        code.outerHTML = code.innerHTML;  // remove <code></code>
        continue;
      }
    }
    i++;
  }
};
slideshow._releaseMath(document);
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>
